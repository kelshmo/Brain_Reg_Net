---
title: "Covariate analysis of MSSM reprocessed transcripts (with TMM normalisation and covariates adjusted)"
author: "Thanneer Perumal"
date: "`r date()`"
output: html_document
---
```{r knit2synapse, eval=FALSE}
library(synapseClient)
library(knit2synapse) # get the package from devtools::install_github('Sage-Bionetworks/knit2synapse')

synapseLogin()

knit2synapse::knitToFolderEntity(file = "./MSSM_REPROCESSED_ISOFORM.Rmd",
                                 parentId = "syn8672415",
                                 entityName = 'MSSM Reprocessed Isoform (Normalised)')
```

```{r libs, echo=FALSE, warning=FALSE, message=FALSE, include=FALSE, cache=FALSE}
## It is assumed your working directory is where this file

## Load required libraries
library(CovariateAnalysis) # get the package from devtools::install_github('th1vairam/CovariateAnalysis@dev')
library(data.table)
library(tidyr)
library(plyr)
library(dplyr)
library(stringr)

library(ggplot2)
library(reshape2)
library(limma)
library(gplots)
library(WGCNA)
library(psych)
library(edgeR)
library(biomaRt)
library(RColorBrewer)

library(synapseClient)
library(knitr)
library(githubr) # get the package from devtools::install_github('brian-bot/githubr')

library(doParallel)
library(foreach)

cl = makeCluster(detectCores()-2)
doParallel::registerDoParallel(cl)

synapseLogin()
source('../R/parallelDuplicateCorrelation.R')

options(xtable.type="html")

knitr::opts_chunk$set(
  echo=FALSE,
  warning=FALSE,
  message=FALSE,
  error = FALSE,
  tidy = FALSE,
  cache = TRUE)
```

```{r synapse.parameters, include=FALSE}
# Synapse parameters
parentId = 'syn8672415'
activityName = 'Covariate analysis';
activityDescription = 'Covariate analysis of MSSM reprocessed transcript data';

thisFileName <- 'MSSM_REPROCESSED_ISOFORM.Rmd'

# Github link
thisRepo <- getRepo(repository = "th1vairam/Brain_Reg_Net", ref="branch", refName='AMPAD_isoform')
thisFile <- getPermlink(repository = thisRepo, repositoryPath=paste0('code/Rmd/',thisFileName))
```
### Data download
#### Obtain count matrix and metadata from synapse.
```{r download.data}
# Get reprocessed sample counts for temporal cortex
COUNT_ID <- 'syn10507727';
ALL_USED_IDs <- COUNT_ID
COUNT <- read.table(synGet(COUNT_ID)@filePath, header=T, sep='\t', check.names = F, row.names = 1)

# Get sample ids
SampleID = data.frame(SampleID = colnames(COUNT),
                 ID = colnames(COUNT)) %>% 
  tidyr::separate(ID, c('A','B','ID'), sep = '_') %>%
  dplyr::select(SampleID, ID) %>%
  dplyr::mutate(ID = as.numeric(ID))

# Get technical metadata
METADATA_TECH_ID <- 'syn6100548'
ALL_USED_IDs[length(ALL_USED_IDs)+1] = METADATA_TECH_ID
METADATA_TECH <- read.table(synGet(METADATA_TECH_ID)@filePath,sep=',',header=T, row.names=1) %>%
  group_by(sampleIdentifier) %>%
  top_n(1, -rRNA.rate) %>%
  dplyr::select(sampleIdentifier, BrodmannArea, barcode, individualIdentifier, batch, RIN) %>%
  unique %>%
  ddply(.(barcode), .fun = function(x){
    x = dplyr::mutate(x, batch = paste(batch, collapse = ''), RIN = sum(RIN, na.rm = T))  
  }) 

# Get 90+ age
METADATA_AGE_ID = 'syn10156693'
ALL_USED_IDs[length(ALL_USED_IDs)+1] = METADATA_AGE_ID
METADATA_AGE <- read.table(synGet(METADATA_AGE_ID)@filePath, sep='\t', header=T) %>%
  dplyr::rename(individualIdentifier = BBid)

# Get clinical metadata
METADATA_CLINICAL_ID <- 'syn6101474'
ALL_USED_IDs[length(ALL_USED_IDs)+1] = METADATA_CLINICAL_ID
METADATA_CLINICAL <- read.csv(synGet(METADATA_CLINICAL_ID)@filePath, header = T)

# Get picard metrics from synapse
METADATA.PICARD_ID <- 'syn8698270';#'syn8380379'
ALL_USED_IDs[length(ALL_USED_IDs)+1] = METADATA.PICARD_ID
METADATA.PICARD <- CovariateAnalysis::downloadFile(METADATA.PICARD_ID) %>%
  dplyr::rename(sampleIdentifier = sample)
colnames(METADATA.PICARD) = gsub('AlignmentSummaryMetrics__','',colnames(METADATA.PICARD))
colnames(METADATA.PICARD) = gsub('RnaSeqMetrics__','',colnames(METADATA.PICARD))

METADATA <- dplyr::full_join(METADATA_TECH, METADATA_CLINICAL) %>%
  dplyr::inner_join(METADATA.PICARD) %>%
  dplyr::select(-AOD) %>%
  dplyr::left_join(METADATA_AGE)
```

### Data preprocessing
```{r preprocess.data,cache=FALSE, echo=TRUE}
# Choose samples with rRNA rate less than 5% and more PF_READS_ALIGNED
METADATA = METADATA %>%
  ddply(.(barcode), .fun = function(x){
    x %>%
      dplyr::filter(PCT_RIBOSOMAL_BASES < 0.05) %>%
      top_n(1, PF_READS_ALIGNED)
  })

# Fix metadata
METADATA = METADATA %>%
  dplyr::mutate(AOD = gsub('\\+','',AOD),
                BrainRegion = factor(BrodmannArea,
                                     levels = c('BM10', 'BM22', 'BM36', 'BM44'),
                                     labels = c('BM10' = 'FP', 'BM22' = 'STG', 
                                                'BM36' = 'PHG', 'BM44' = 'IFG')),
                Diagnosis = 'NONE', 
                RIN2 = RIN^2)

METADATA$Diagnosis = 'OTHER'
METADATA$Diagnosis[METADATA$CDR <= 0.5 & METADATA$bbscore <= 3 & METADATA$NP.1 <= 1] = 'CONTROL'
METADATA$Diagnosis[METADATA$CDR >= 1 & METADATA$bbscore >= 4 & METADATA$NP.1 >= 2] = 'AD'

levels(METADATA$batch)[levels(METADATA$batch) == ''] = 'NoBatch'

METADATA = METADATA %>%
  dplyr::mutate(BrainRegion1 = BrainRegion) %>%
  tidyr::unite(BrainRegion.Diagnosis, BrainRegion, Diagnosis, sep = '.')

METADATA <- METADATA %>%
  filter(!is.na(BrainRegion.Diagnosis), !is.na(PMI), !is.na(RIN))

# Fix RIN values for some samples (Based on email conversation with Minghui May 22 2017)
FIX.RIN = c(hB_RNA_12312_resequenced = 3.9,
            hB_RNA_12342 = 3.9,
            hB_RNA_12352 = 4.2,
            hB_RNA_9191 = 5,
            hB_RNA_12262_resequenced = 5.2,
            hB_RNA_9216 = 5.7,
            hB_RNA_12272_resequenced = 5.8,
            hB_RNA_12382 = 5.8, 
            hB_RNA_13359 = 6.4)
rownames(METADATA) = METADATA$sampleIdentifier
METADATA[names(FIX.RIN),'RIN'] = FIX.RIN

METADATA = METADATA %>%
  dplyr::filter(RIN >= 5)

METADATA$ApoE[METADATA$Apo1 != 4 & METADATA$Apo2 != 4] = 0
METADATA$ApoE[METADATA$Apo1 == 4 | METADATA$Apo2 == 4] = 1
METADATA$ApoE[METADATA$Apo1 == 4 & METADATA$Apo2 == 4] = 2
METADATA$BrainRegion.ApoE = paste(METADATA$BrainRegion1, METADATA$ApoE, sep = '.') %>%
  factor()
```

```{r preprocess.data1}
# Match covariates to expression data
indToRetain = intersect(METADATA$sampleIdentifier, colnames(COUNT))
indRemoved = setdiff(colnames(COUNT), METADATA$sampleIdentifier)

COUNT <- COUNT[, indToRetain]

METADATA = as.data.frame(METADATA)
rownames(METADATA) = METADATA$sampleIdentifier
METADATA = METADATA[indToRetain,]
```
`r dim(COUNT)[2]` samples from `r length(unique(METADATA$individualIdentifier))` subjects were obtained from the MSSM cohorts in AMP-AD reprocessed rnaseq project. 

Following `r length(indRemoved)` samples were removed: `r indRemoved`

### Covariate clustering
Determine relationship between covariates
```{r covariates.clustering}
primaryVariable <- c("CDR", "BrainRegion.Diagnosis", "BrainRegion.ApoE")
FactorCovariates <- c("individualIdentifier", "batch", "RACE", "SEX", "BrainRegion.Diagnosis", "CDR", "BrainRegion.ApoE")
ContCovariates <- c("RIN", "RIN2", "AOD","PMI")

# Find inter relation between factor covariates
COVARIATES = METADATA[,c(FactorCovariates,ContCovariates),drop=F]
rownames(COVARIATES) <- METADATA$sampleIdentifier

# Convert factor covariates to factors
COVARIATES[,FactorCovariates] = lapply(COVARIATES[,FactorCovariates], factor)
COVARIATES[,ContCovariates] = lapply(COVARIATES[,ContCovariates], as.character)
COVARIATES[,ContCovariates] = lapply(COVARIATES[,ContCovariates], as.numeric)
```
Correlation/association between covariates at an FDR <= 0.1
```{r covariates.correlation, fig.width=10, fig.height=6}
COVARIATES.CORRELATION = getAssociationStatistics(COVARIATES, PVAL = 0.05)
draw(COVARIATES.CORRELATION$plot, heatmap_legend_side = 'left', padding  = unit(c(18,2,2,18), 'mm'))
```

```{r data.explore, fig.width = 12, fig.height = 5}
my.theme = theme(legend.position = 'top', axis.text.x = element_text(angle = 90, hjust = 1))

# RIN
p = list()
p[[1]] = ggplot(COVARIATES, aes(x = BrainRegion.Diagnosis, y = RIN)) + geom_boxplot()
p[[1]] = p[[1]] + ggtitle('RIN') + my.theme

# Age Of Death
p[[2]] = ggplot(COVARIATES, aes(x = BrainRegion.Diagnosis, y = as.numeric(AOD))) + geom_boxplot()
p[[2]] = p[[2]] + ggtitle('AOD') + my.theme

# PMI
p[[3]] = ggplot(COVARIATES, aes(x = BrainRegion.Diagnosis, y = as.numeric(PMI))) + geom_boxplot()
p[[3]] = p[[3]] + ggtitle('PMI') + my.theme

multiplot(plotlist = p, cols = 3)
```
### Filter genes
Remove genes that have less than 5 tpm counts in at least 50% of samples per BrainRegion x Diagnosis
```{r cpmnormalisation}
genesToAnalyze = COVARIATES %>%
  rownameToFirstColumn('SampleID') %>%
  dlply(.(BrainRegion.Diagnosis), .fun = function(mtd, count){
    processed.counts = getGeneFilteredGeneExprMatrix(count[,mtd$SampleID],
                                                     MIN_GENE_CPM=5, 
                                                     MIN_SAMPLE_PERCENT_WITH_MIN_GENE_CPM=0.5)
  processed.counts$filteredExprMatrix$genes
}, COUNT)

genesToAnalyze = unlist(genesToAnalyze) %>% 
  unique() %>%
  setdiff(c("N_unmapped", "N_multimapping", "N_noFeature", "N_ambiguous"))

PROCESSED_COUNTS = getGeneFilteredGeneExprMatrix(COUNT[genesToAnalyze, ], 
                                                 MIN_GENE_CPM=0, 
                                                 MIN_SAMPLE_PERCENT_WITH_MIN_GENE_CPM=0)
```

### Outlier Analysis
```{r outlier.analysis, cache = FALSE, fig.width = 10}
indToRemove = c('hB_RNA_10622')

# Find principal components of expression to plot
PC <- prcomp(voom(PROCESSED_COUNTS$filteredExprMatrix$counts)$E, scale.=T, center = T)

# Plot first 2 PCs
plotdata <- data.frame(SampleID=rownames(PC$rotation), 
                       PC1=PC$rotation[,1], 
                       PC2=PC$rotation[,2])

plotdata <- left_join(plotdata, rownameToFirstColumn(COVARIATES, 'SampleID')) %>%
  dplyr::mutate(label = SampleID) %>%
  tidyr::separate(BrainRegion.Diagnosis, c('BrainRegion', 'Diagnosis'), sep = '\\.')
plotdata$label[!(plotdata$SampleID %in% indToRemove)] = ''

p <- ggplot(plotdata, aes(x=PC1, y=PC2))
p <- p + geom_point(aes(color=Diagnosis, size=RIN, shape = SEX))
p <- p + theme_bw() + theme(legend.position="right")
p <- p + geom_text(aes(label= label), size=4, hjust=0)
p

# Plot abberent distribution of logcpm counts
tmp1 = voom(PROCESSED_COUNTS$filteredExprMatrix$counts)$E %>%
  rownameToFirstColumn('Gene.ID') %>%
  tidyr::gather(SampleID, logCPM, -Gene.ID) %>%
  left_join(COVARIATES %>%
              rownameToFirstColumn('SampleID')) %>%
  tidyr::separate(BrainRegion.Diagnosis, c('BrainRegion', 'Diagnosis'), sep = '\\.')

p = ggplot(tmp1 %>%
             dplyr::filter(SampleID %in% indToRemove),
           aes(x = logCPM, color = SampleID)) + geom_density() 
p = p + theme(legend.position = 'top') + facet_grid(Diagnosis+.~BrainRegion)
p

indToRetain = setdiff(colnames(PROCESSED_COUNTS$filteredExprMatrix$counts), indToRemove)
PROCESSED_COUNTS$filteredExprMatrix$counts = PROCESSED_COUNTS$filteredExprMatrix$counts[,indToRetain]
COVARIATES = COVARIATES[indToRetain,]

tmp = COVARIATES %>%
  tidyr::separate(BrainRegion.Diagnosis, c('BrainRegion', 'Diagnosis'), sep = '\\.') %>%
  group_by(BrainRegion, Diagnosis) %>%
  summarise(count = n()) %>%
  spread(Diagnosis, count)
```
Processing `r dim(PROCESSED_COUNTS$filteredExprMatrix)[1]` genes in `r dim(PROCESSED_COUNTS$filteredExprMatrix)[2]` samples

Based on the expression pattern following samples were tagged as outliers: `r paste(indToRemove, collapse = ', ')`

Distribution of samples are: `r kable(tmp)`

### Winsorise counts (Gene outliers in samples)
```{r winsorise.data}
LOG.CPM = cpm(PROCESSED_COUNTS$filteredExprMatrix$counts, log = T)

# Set gene counts in specific samples that are deviating 3 sd from other samples to 3SD limit
LOG.CPM = apply(LOG.CPM, 1, function(x){
  mn = mean(x, na.rm = T)
  std.dev = sd(x, na.rm = T)
  
  ind.low = which(x == max(x[which(x <= mn-3*std.dev)], na.rm = T))
  ind.high = which(x == min(x[which(x >= mn+3*std.dev)], na.rm = T))
  
  x[x < (mn-3*std.dev)] = x[ind.low]
  x[x > (mn+3*std.dev)] = x[ind.high]
  return(x)
}) %>% t

# Back calculate counts for further analysis
LIB.SIZE = colSums(PROCESSED_COUNTS$filteredExprMatrix$counts)
NEW.COUNTS = (2^LOG.CPM) * t(replicate(dim(LOG.CPM)[1], LIB.SIZE))/1e6
```

### Library Normalisation
Initial library normalisation usign tmm
```{r tmm}
# Compute offset for gene length and gc content
TMM.GENE_EXPRESSION = calcNormFactors(NEW.COUNTS, method = 'TMM')
VOOM.GENE_EXPRESSION = voom(NEW.COUNTS, design = NULL, lib.size = TMM.GENE_EXPRESSION * LIB.SIZE)
  
# Set gene counts in specific samples that are deviating 3 sd from other samples to 3SD limit
LOG.CPM = apply(VOOM.GENE_EXPRESSION$E, 1, function(x){
  mn = mean(x, na.rm = T)
  std.dev = sd(x, na.rm = T)
  
  ind.low = which(x == max(x[which(x <= mn-3*std.dev)], na.rm = T))
  ind.high = which(x == min(x[which(x >= mn+3*std.dev)], na.rm = T))
  
  x[x < (mn-3*std.dev)] = x[ind.low]
  x[x > (mn+3*std.dev)] = x[ind.high]
  return(x)
}) %>% t
VOOM.GENE_EXPRESSION$E = LOG.CPM
NEW.COUNTS = (2^LOG.CPM) * t(replicate(dim(LOG.CPM)[1], LIB.SIZE))/1e6
```

```{r explore.data, cache=FALSE, fig.height=5, fig.width=10}
# Plot abberent distribution of logcpm counts
tmp1 = (VOOM.GENE_EXPRESSION$E) %>%
  rownameToFirstColumn('Gene.ID') %>%
  tidyr::gather(SampleID, logCPM, -Gene.ID) %>%
  left_join(COVARIATES %>%
              rownameToFirstColumn('SampleID')) %>%
  tidyr::separate(BrainRegion.Diagnosis, c('BrainRegion', 'Diagnosis'), sep = '\\.')

p = ggplot(tmp1, aes(x = logCPM, color = SampleID)) + geom_density() 
p = p + theme(legend.position = 'NONE') + facet_grid(BrainRegion+.~Diagnosis, scale = 'free')
p
```
Coexpression of genes 
```{r coexp1, cache=FALSE, fig.height=5, fig.width=5}
cr = cor(t(VOOM.GENE_EXPRESSION$E))
hist(cr, main = 'Distribution of correlation between genes', xlab = 'Correlation')
```
### Decomposition of expression
Clustering of library normalised unadjusted data (with NULL design)
```{r decompse.normalise.data1.1, fig.height=5, fig.width=10, results='asis'}
# Find principal components of expression to plot
PC <- prcomp(VOOM.GENE_EXPRESSION$E, scale.=T, center = T)

# Plot first 2 PCs
plotdata <- data.frame(SampleID=rownames(PC$rotation), 
                       PC1=PC$rotation[,1], 
                       PC2=PC$rotation[,2])

plotdata <- left_join(plotdata, rownameToFirstColumn(COVARIATES, 'SampleID')) %>%
  tidyr::separate(BrainRegion.Diagnosis, c('Region','Diagnosis'), sep = '\\.') %>% 
  dplyr::mutate(Region = factor(Region), batch = factor(batch))

p <- ggplot(plotdata, aes(x=PC1, y=PC2))
p <- p + geom_point(aes(color=Diagnosis, size=RIN, shape = SEX))
p <- p + theme_bw() + theme(legend.position="right") + facet_grid(.~Region, scales = 'free_y')
p
```
Tree based classification of samples
```{r decompse.normalise.data1.2, fig.height=6, fig.width=10, results='asis'}
# Eucledian tree based analysis
COVARIATES.tmp = (COVARIATES[,c(FactorCovariates), drop = F])
COVARIATES.tmp[is.na(COVARIATES.tmp)] = 0

tree = hclust(as.dist(t(VOOM.GENE_EXPRESSION$E)))
cols = WGCNA::labels2colors(COVARIATES.tmp);

WGCNA::plotDendroAndColors(tree, 
                           colors = cols, 
                           dendroLabels = FALSE, 
                           abHeight = 0.80, 
                           main = "Sample dendrogram",
                           groupLabels = colnames(COVARIATES.tmp))
```

```{r temp, include = F}
dev.off()
gc()
```

### Significant Covariates
Correlation between pca of unadjusted mRNA expression and covariates are used to find significant covariates
```{r preadj.covariates}
# Find correlation between PC's of gene expression with covariates
preAdjustedSigCovars = runPCAandPlotCorrelations(VOOM.GENE_EXPRESSION$E, 
                                                 COVARIATES,
                                                 'NULL design(voom-normalized)', 
                                                 isKeyPlot=TRUE, 
                                                 MIN_PVE_PCT_PC = 1)
```

Significant covariates to adjust at FDR 0.1 are `r preAdjustedSigCovars$significantCovars`
```{r preadj.covariates.plot, fig.width=12, fig.height=8}
preAdjustedSigCovars[["PC_res"]][[2]]$plotData
```
### Normalisation (iterative design)
Since many covariates are correlated, re-normalising and re-adjusting tpm counts with an iterative design matrix.

NOTE:
1. Using a mixed effect model where random effect is chosen as individualIdentifier
2. Adding batch and SEX a priori to variable selection
3. Primary variable of interest BrainRegion.Diagnosis is excluded from the pool of available covariates for selection
```{r iterative.norm, results='asis'}
# Primary variable of interest
postAdjustCovars = c('batch', 'SEX');

# Assign residual covariates
residualCovars = setdiff(preAdjustedSigCovars$significantCovars, 
                         c(postAdjustCovars, primaryVariable, 'individualIdentifier'))
residualSigCovars = preAdjustedSigCovars
covariatesEffects = preAdjustedSigCovars$Effects.significantCovars[residualCovars]
postAdjustCovars = c(postAdjustCovars, names(which.max(covariatesEffects))) %>% unique()

loopCount = 0 
while(length(residualSigCovars$significantCovars)!=0 && loopCount <= 20){
  writeLines(paste('Using following covariates in the model:',
                   paste(postAdjustCovars, collapse=', '),
                   'as fixed effects and individualIdentifier as random effect'))

  # Post adjusted design matrix
  DM1 = getDesignMatrix(COVARIATES[,postAdjustCovars,drop=F],Intercept = F)
  DM1$design = DM1$design[,linColumnFinder(DM1$design)$indepCols]

  # Estimate voom weights for dispersion control
  VOOM.GENE_EXPRESSION = voom(NEW.COUNTS, design=DM1$design, plot=F, lib.size = TMM.GENE_EXPRESSION * LIB.SIZE)

  # # Calculate correlation values of random effects
  correlation = parallelDuplicateCorrelation(VOOM.GENE_EXPRESSION,
                                             block = COVARIATES$individualIdentifier)
  
  # Re-estimate voom weights
  VOOM.GENE_EXPRESSION = voom(NEW.COUNTS, 
                              design=DM1$design, plot=F, 
                              block = COVARIATES$individualIdentifier, 
                              correlation = correlation$cor,
                              lib.size = TMM.GENE_EXPRESSION * LIB.SIZE)

  # Fit linear model using new weights and new design
  VOOM.ADJUSTED.FIT = lmFit(VOOM.GENE_EXPRESSION$E,
                            design = DM1$design,
                            weights = VOOM.GENE_EXPRESSION$weights,
                            block = COVARIATES$individualIdentifier, 
                            correlation = correlation$cor)

  # Residuals after normalisation
  RESIDUAL.GENE_EXPRESSION = residuals.MArrayLM(VOOM.ADJUSTED.FIT,
                                                VOOM.GENE_EXPRESSION$E)

  # Residual covariates to choose from
  residCovars <- setdiff(c(FactorCovariates,ContCovariates),
                         c(postAdjustCovars, primaryVariable, 'individualIdentifier'))

  # Find PC of residual gene expression and significant covariates that are highly correlated with PCs
  residualSigCovars = runPCAandPlotCorrelations(RESIDUAL.GENE_EXPRESSION, 
                                                COVARIATES[, residCovars, drop=F], 
                                                'adjusted design(voom-normalized)',
                                                isKeyPlot=TRUE)

  # Add postadjusted covariates (if any)
  residCovars = setdiff(residualSigCovars$significantCovars, 
                        c(postAdjustCovars, primaryVariable, 'individualIdentifier'))
  covariatesEffects = residualSigCovars$Effects.significantCovars[residCovars]

  postAdjustCovars = c(postAdjustCovars, names(which.max(covariatesEffects)))
  loopCount = loopCount + 1
}
modelStr <- paste(paste(gsub('_','\\\\_',postAdjustCovars), collapse=', '),
                  'as fixed effects')

tmp <- paste('Using following covariates in the final model:', modelStr)
```
`r tmp`
### Sanity check
```{r residual.adj, fig.width=12, fig.height=8}
# Find PC of residual gene expression and significant covariates that are highly correlated with PCs
residualSigCovars = runPCAandPlotCorrelations(RESIDUAL.GENE_EXPRESSION, 
                                              COVARIATES,
                                              'adjusted design(voom-normalized)',
                                              isKeyPlot=TRUE)

residualSigCovars[["PC_res"]][[2]]$plotData
```
Coexpression of genes 
```{r coexp2, cache=FALSE, fig.height=5, fig.width=5}
cr = cor(t(RESIDUAL.GENE_EXPRESSION))
hist(cr, main = 'Distribution of correlation between genes', xlab = 'Correlation')
```

### Clustering residual data
```{r decompse.normalise.data2.1, fig.height=6, fig.width=10, results='asis'}
# Find principal components of expression to plot
PC <- prcomp(RESIDUAL.GENE_EXPRESSION, scale.=T, center = T)

# Plot first 2 PCs
plotdata <- data.frame(SampleID=rownames(PC$rotation), 
                       PC1=PC$rotation[,1], 
                       PC2=PC$rotation[,2])

plotdata <- left_join(plotdata, rownameToFirstColumn(COVARIATES, 'SampleID')) %>%
  tidyr::separate(BrainRegion.Diagnosis, c('Region','Diagnosis'), sep = '\\.') %>% 
  dplyr::mutate(Region = factor(Region))

p <- ggplot(plotdata, aes(x=PC1, y=PC2))
p <- p + geom_point(aes(color=Diagnosis, size=RIN, shape = SEX))
p <- p + theme_bw() + theme(legend.position="right") + facet_grid(.~Region, scales = 'free_y')
p
```

```{r decompse.normalise.data2.2, fig.height=8, fig.width=12, results='asis'}
# Eucledian tree based analysis
COVARIATES.tmp = data.matrix(COVARIATES[,FactorCovariates])
COVARIATES.tmp[is.na(COVARIATES.tmp)] = 0

tree = hclust(as.dist(t(RESIDUAL.GENE_EXPRESSION)))
cols = WGCNA::labels2colors(COVARIATES.tmp);

WGCNA::plotDendroAndColors(tree, 
                           colors = cols, 
                           dendroLabels = FALSE, 
                           abHeight = 0.80, 
                           main = "Sample dendrogram",
                           groupLabels = colnames(COVARIATES.tmp))
```

```{r temp1, include=F}
dev.off()
gc()
```

### Differential expression analysis (with BrainRegion.CDR as primary variable)
Differential expression is performed on the primary variable by controlling for covariates identified above

Interpretation of BrainRegion.CDR
1. FP.CDR: change in CDR in frontal pole where 0 no cognitive decline and 5 severe cognitive decline
2. IFG.CDR: change in CDR in inferior frontal gyrus where 0 no cognitive decline and 5 severe cognitive decline
3. PHG.CDR: change in CDR in parahippocampal gyrus where 0 no cognitive decline and 5 severe cognitive decline
4. STG.CDR: change in CDR in superior temporal gyrus where 0 no cognitive decline and 5 severe cognitive decline

Genes that are differentially expressed at an FDR <= 0.05 are
```{r diff.exp, fig.height=6, fig.width=15}
# Get design matrix
COVARIATES.tmp = COVARIATES %>%
  tidyr::separate(BrainRegion.Diagnosis, c('BrainRegion', 'Diagnosis'), sep = '\\.') %>%
  dplyr::mutate(BrainRegion = factor(BrainRegion))

DESIGN = getDesignMatrix(COVARIATES.tmp[, c('BrainRegion', postAdjustCovars), drop = F], Intercept = F)
ind = grep('BrainRegion', colnames(DESIGN$design))
DESIGN$design[,ind] = DESIGN$design[,ind] * as.numeric(COVARIATES.tmp[,'CDR'])
colnames(DESIGN$design)[ind] = paste0(colnames(DESIGN$design),'.CDR')
DESIGN$design = DESIGN$design[,linColumnFinder(DESIGN$design)$indepCols]

# Estimate voom weights for dispersion control
VOOM.WEIGHTS = voom(NEW.COUNTS, design=DESIGN$design, plot=F, lib.size = TMM.GENE_EXPRESSION * LIB.SIZE)

# Calculate correlation values of random effects
correlation = parallelDuplicateCorrelation(VOOM.WEIGHTS, block = COVARIATES$individualIdentifier)
  
# Re-estimate voom weights
VOOM.WEIGHTS = voom(NEW.COUNTS,
                    design=DESIGN$design, plot=F,
                    block = COVARIATES$individualIdentifier, 
                    correlation = correlation$cor,
                    lib.size = TMM.GENE_EXPRESSION * LIB.SIZE)

# Fit linear model using new weights and new design
FIT = lmFit(VOOM.WEIGHTS$E,
            weights = VOOM.WEIGHTS$weights,
            design=DESIGN$design,
            block = COVARIATES$individualIdentifier, 
            correlation = correlation$cor)

# Fit contrast
contrast = makeContrasts(contrasts = c("BrainRegionFP.CDR", 
                                       "BrainRegionIFG.CDR", 
                                       "BrainRegionPHG.CDR", 
                                       "BrainRegionSTG.CDR"),
                         levels = colnames(FIT$coefficients))
FIT.CONTR = contrasts.fit(FIT, contrasts=contrast)
FIT.CONTR = eBayes(FIT.CONTR)

# Get differnetial expression
DE = lapply(1:dim(contrast)[2], function(i, FIT){
  topTable(FIT, coef=i, number = 50000, confint = T) %>%
    rownameToFirstColumn('Tx.ID')
}, FIT.CONTR)
names(DE) = colnames(contrast)

DE = DE %>% 
  rbindlist(idcol = 'Comparison') %>%
  dplyr::mutate(Comparison = gsub('BrainRegion','',Comparison),
                Study = 'MSSM',
                Direction = logFC/abs(logFC),
                Direction = factor(Direction, c(-1,1), c('-1' = 'DOWN', '1' = 'UP')),
                Direction = as.character(Direction)) %>%
  dplyr::rename(BrainRegion = Comparison) %>%
  dplyr::mutate(Comparison = 'CDR')
DE$Direction[DE$adj.P.Val > 0.05 | abs(DE$logFC) < log2(1.2)] = 'NONE'

tmp = DE %>%
  dplyr::select(Tx.ID, Comparison, Direction, BrainRegion) %>%
  group_by(BrainRegion, Comparison, Direction) %>%
  dplyr::summarise(FDR_0_05_FC_1.2 = length(unique(Tx.ID))) %>%
  spread(Direction, FDR_0_05_FC_1.2) 
kable(tmp)

p = ggplot(DE, aes(y = -log10(adj.P.Val), x = logFC, color = Direction)) + geom_point() + xlim(c(-1,1))
p = p + scale_color_manual(values = c('green','grey','red')) + theme(legend.position = 'top')
p = p + facet_grid(Comparison+.~BrainRegion, scales = 'free')
p

all.diff.exp = list(CDR = DE)
all.fit = list(CDR = FIT)
```

### Differential expression analysis (with BrainRegion.Diagnosis as primary variable)
Differential expression is performed on the primary variable by controlling for covariates identified above

Interpretation of BrainRegion.Diagnosis
1. FP.AD: Samples from frontal pole region with CDR >= 1 and bbscore >= 4 and NP.1 >= 2
2. FP.CONTROL: Samples from frontal pole region with CDR <= 0.5 and bbscore <= 3 and NP.1 <= 1
3. FP.OTHER: All the other frontal pole samples
4. PHG.AD: Samples from parahippocampal gyrus region with CDR >= 1 and bbscore >= 4 and NP.1 >= 2
5. PHG.CONTROL: Samples from parahippocampal gyrus region with CDR <= 0.5 and bbscore <= 3 and NP.1 <= 1
6. PHG.OTHER:All the other parahippocampal gyrus samples
7. STG.AD: Samples from frontal superior temporal gyrus with CDR >= 1 and bbscore >= 4 and NP.1 >= 2
8. STG.CONTROL: Samples from superior temporal gyrus region with CDR <= 0.5 and bbscore <= 3 and NP.1 <= 1
9. STG.OTHER: All the other superior temporal gyrus samples
10. IFG.AD: Samples from inferior frontal gyrus region with CDR >= 1 and bbscore >= 4 and NP.1 >= 2
11. IFG.CONTROL: Samples from inferior frontal gyrus region with CDR <= 0.5 and bbscore <= 3 and NP.1 <= 1
12. IFG.OTHER: All the other inferior frontal gyrus samples

Genes that are differentially expressed at an FDR <= 0.05 are
```{r diff.exp1, fig.height=15, fig.width=13}
# Get design matrix
DESIGN = getDesignMatrix(COVARIATES[, c(primaryVariable[2], postAdjustCovars), drop = F], Intercept = F)
DESIGN$design = DESIGN$design[,linColumnFinder(DESIGN$design)$indepCols]

# Estimate voom weights for dispersion control
VOOM.WEIGHTS = voom(NEW.COUNTS, design=DESIGN$design, plot=F, lib.size = TMM.GENE_EXPRESSION * LIB.SIZE)

# Calculate correlation values of random effects
correlation = parallelDuplicateCorrelation(VOOM.WEIGHTS, block = COVARIATES$individualIdentifier)
  
# Re-estimate voom weights
VOOM.WEIGHTS = voom(NEW.COUNTS,
                    design=DESIGN$design, plot=F,
                    block = COVARIATES$individualIdentifier, 
                    correlation = correlation$cor, 
                    lib.size = TMM.GENE_EXPRESSION * LIB.SIZE)

# Fit linear model using new weights and new design
FIT = lmFit(VOOM.WEIGHTS$E,
            weights = VOOM.WEIGHTS$weights,
            design=DESIGN$design,
            block = COVARIATES$individualIdentifier, 
            correlation = correlation$cor)

# Fit contrast
cntr = c()
for (region in c('FP', 'STG', 'PHG', 'IFG')){
  tmp = combn(paste0('BrainRegion.Diagnosis', region, '.', c('AD', 'OTHER', 'CONTROL')),2)
  cntr = c(cntr, apply(tmp, 2, paste, collapse = '-'))
}

contrast = makeContrasts(contrasts=cntr,
                         levels = colnames(FIT$coefficients))
FIT.CONTR = contrasts.fit(FIT, contrasts=contrast)
FIT.CONTR = eBayes(FIT.CONTR)

# Get differnetial expression
DE = lapply(1:12, function(i, FIT){
  topTable(FIT, coef=i, number = 50000, confint = T) %>%
    rownameToFirstColumn('Tx.ID')
}, FIT.CONTR)
names(DE) = colnames(contrast)

DE = DE %>% 
  rbindlist(idcol = 'Comparison') %>%
  dplyr::mutate(Comparison = gsub('BrainRegion.Diagnosis','',Comparison),
                Study = 'MSSM',
                Direction = logFC/abs(logFC),
                Direction = factor(Direction, c(-1,1), c('-1' = 'DOWN', '1' = 'UP')),
                Direction = as.character(Direction)) %>%
  tidyr::separate(Comparison, c('from.state','to.state'), sep = '-') %>%
  tidyr::separate(from.state, c('BrainRegion','reference'), sep = '\\.') %>%
  tidyr::separate(to.state, c('BrainRegion1','against'), sep = '\\.') %>%
  dplyr::mutate(Comparison = paste(reference, against, sep = '-')) %>%
  dplyr::select(-BrainRegion1)
DE$Direction[DE$adj.P.Val > 0.05 | abs(DE$logFC) < log2(1.2)] = 'NONE'

tmp = DE %>%
  dplyr::select(Tx.ID, Comparison, Direction, BrainRegion) %>%
  group_by(BrainRegion, Comparison, Direction) %>%
  dplyr::summarise(FDR_0_05_FC_1.2 = length(unique(Tx.ID))) %>%
  spread(Direction, FDR_0_05_FC_1.2) 
kable(tmp)

p = ggplot(DE, aes(y = -log10(adj.P.Val), x = logFC, color = Direction)) + geom_point() + xlim(c(-1,1))
p = p + scale_color_manual(values = c('green','grey','red')) + theme(legend.position='top')
p = p + facet_grid(BrainRegion+.~Comparison, scales = 'fixed')
p

all.diff.exp = c(all.diff.exp, list(Diagnosis = DE))
all.fit = c(all.fit, list(Diagnosis = FIT))
```

### Differential expression analysis (with BrainRegion.ApoE as primary variable)
Differential expression is performed on the primary variable by controlling for covariates identified above

Genes that are differentially expressed at an FDR <= 0.05 are
```{r diff.exp2, fig.height=15, fig.width=13}
# Get design matrix
DESIGN = getDesignMatrix(COVARIATES[, c(primaryVariable[3], postAdjustCovars), drop = F], Intercept = F)
DESIGN$design = DESIGN$design[,linColumnFinder(DESIGN$design)$indepCols]

# Estimate voom weights for dispersion control
VOOM.WEIGHTS = voom(NEW.COUNTS, design=DESIGN$design, plot=F, lib.size = TMM.GENE_EXPRESSION * LIB.SIZE)

# Calculate correlation values of random effects
correlation = parallelDuplicateCorrelation(VOOM.WEIGHTS, block = COVARIATES$individualIdentifier)
  
# Re-estimate voom weights
VOOM.WEIGHTS = voom(NEW.COUNTS,
                    design=DESIGN$design, plot=F,
                    block = COVARIATES$individualIdentifier, 
                    correlation = correlation$cor,
                    lib.size = TMM.GENE_EXPRESSION * LIB.SIZE)

# Fit linear model using new weights and new design
FIT = lmFit(VOOM.WEIGHTS$E,
            weights = VOOM.WEIGHTS$weights,
            design=DESIGN$design, 
            block = COVARIATES$individualIdentifier, 
            correlation = correlation$cor)

# Fit contrast
cntr = c()
for (region in c('FP', 'STG', 'PHG', 'IFG')){
  tmp = combn(paste0('BrainRegion.ApoE', region, '.', c('0', '1', '2')),2)
  cntr = c(cntr, apply(tmp, 2, paste, collapse = '-'))
}

contrast = makeContrasts(contrasts=cntr,
                         levels = colnames(FIT$coefficients))
FIT.CONTR = contrasts.fit(FIT, contrasts=contrast)
FIT.CONTR = eBayes(FIT.CONTR)

# Get differnetial expression
DE = lapply(1:dim(contrast)[2], function(i, FIT){
  topTable(FIT, coef=i, number = 50000, confint = T) %>%
    rownameToFirstColumn('Tx.ID')
}, FIT.CONTR)
names(DE) = colnames(contrast)

DE = DE %>% 
  rbindlist(idcol = 'Comparison') %>%
  dplyr::mutate(Comparison = gsub('BrainRegion.ApoE','',Comparison),
                Study = 'MSSM',
                Direction = logFC/abs(logFC),
                Direction = factor(Direction, c(-1,1), c('-1' = 'DOWN', '1' = 'UP')),
                Direction = as.character(Direction)) %>%
  tidyr::separate(Comparison, c('from.state','to.state'), sep = '-') %>%
  tidyr::separate(from.state, c('BrainRegion','reference'), sep = '\\.') %>%
  tidyr::separate(to.state, c('BrainRegion1','against'), sep = '\\.') %>%
  dplyr::mutate(Comparison = paste(reference, against, sep = '-')) %>%
  dplyr::select(-BrainRegion1)
DE$Direction[DE$adj.P.Val > 0.05 | abs(DE$logFC) < log2(1.2)] = 'NONE'

tmp = DE %>%
  dplyr::select(Tx.ID, Comparison, Direction, BrainRegion) %>%
  group_by(BrainRegion, Comparison, Direction) %>%
  dplyr::summarise(FDR_0_05_FC_1.2 = length(unique(Tx.ID))) %>%
  spread(Direction, FDR_0_05_FC_1.2) 
kable(tmp)

p = ggplot(DE, aes(y = -log10(adj.P.Val), x = logFC, color = Direction)) + geom_point() + xlim(c(-1,1))
p = p + scale_color_manual(values = c('green','grey','red')) + theme(legend.position='top')
p = p + facet_grid(BrainRegion+.~Comparison, scales = 'fixed')
p

all.diff.exp = c(all.diff.exp, list(ApoE = DE))
all.fit = c(all.fit, list(ApoE = FIT))
```

### Differential expression analysis (with BrainRegion.Diagnosis and Gender)
Differential expression is performed on the BrainRegion.Diagnosis x Gender variable by controlling for covariates identified above

Genes that are differentially expressed at an FDR <= 0.05 and folde change of 1.2 are
```{r diff.exp3, fig.height=15, fig.width=13}
## Modeling Diagnosis, msex and age_death conjointly
COVARIATES$BrainRegion.Diagnosis.SEX = paste(COVARIATES$BrainRegion.Diagnosis, 
                                             factor(COVARIATES$SEX, labels = c('F' = 'FEMALE', 'M' = 'MALE')), 
                                             sep = '.') %>% factor

# Get design matrix
DESIGN = getDesignMatrix(COVARIATES[, c('BrainRegion.Diagnosis.SEX', setdiff(postAdjustCovars, 'SEX')), drop = F], Intercept = F)
DESIGN$design = DESIGN$design[,linColumnFinder(DESIGN$design)$indepCols]

# Estimate voom weights for dispersion control
VOOM.WEIGHTS = voom(PROCESSED_COUNTS$filteredExprMatrix$counts, design=DESIGN$design, plot=F, lib.size = TMM.GENE_EXPRESSION * LIB.SIZE)

# Calculate correlation values of random effects
correlation = parallelDuplicateCorrelation(VOOM.WEIGHTS, block = COVARIATES$individualIdentifier)
  
# Re-estimate voom weights
VOOM.WEIGHTS = voom(PROCESSED_COUNTS$filteredExprMatrix$counts,
                    design=DESIGN$design, plot=F,
                    block = COVARIATES$individualIdentifier, 
                    correlation = correlation$cor,
                    lib.size = TMM.GENE_EXPRESSION * LIB.SIZE)

# Fit linear model using new weights and new design
FIT = lmFit(VOOM.WEIGHTS$E,
            weights = VOOM.WEIGHTS$weights,
            design=DESIGN$design,
            block = COVARIATES$individualIdentifier, 
            correlation = correlation$cor)

# Fit contrast
cntr = c('BrainRegion.Diagnosis.SEXIFG.AD.MALE-BrainRegion.Diagnosis.SEXIFG.CONTROL.MALE',
         'BrainRegion.Diagnosis.SEXIFG.AD.FEMALE-BrainRegion.Diagnosis.SEXIFG.CONTROL.FEMALE',
         '0.5*BrainRegion.Diagnosis.SEXIFG.AD.MALE+0.5*BrainRegion.Diagnosis.SEXIFG.AD.FEMALE
         -0.5*BrainRegion.Diagnosis.SEXIFG.CONTROL.MALE-0.5*BrainRegion.Diagnosis.SEXIFG.CONTROL.FEMALE',
         '0.5*BrainRegion.Diagnosis.SEXIFG.AD.FEMALE+0.5*BrainRegion.Diagnosis.SEXIFG.CONTROL.FEMALE
         -0.5*BrainRegion.Diagnosis.SEXIFG.AD.MALE-0.5*BrainRegion.Diagnosis.SEXIFG.CONTROL.FEMALE',
         '0.5*BrainRegion.Diagnosis.SEXIFG.AD.FEMALE-0.5*BrainRegion.Diagnosis.SEXIFG.CONTROL.FEMALE
         -0.5*BrainRegion.Diagnosis.SEXIFG.AD.MALE+0.5*BrainRegion.Diagnosis.SEXIFG.CONTROL.MALE',
         'BrainRegion.Diagnosis.SEXFP.AD.MALE-BrainRegion.Diagnosis.SEXFP.CONTROL.MALE',
         'BrainRegion.Diagnosis.SEXFP.AD.FEMALE-BrainRegion.Diagnosis.SEXFP.CONTROL.FEMALE',
         '0.5*BrainRegion.Diagnosis.SEXFP.AD.MALE+0.5*BrainRegion.Diagnosis.SEXFP.AD.FEMALE
         -0.5*BrainRegion.Diagnosis.SEXFP.CONTROL.MALE-0.5*BrainRegion.Diagnosis.SEXFP.CONTROL.FEMALE',
         '0.5*BrainRegion.Diagnosis.SEXFP.AD.FEMALE+0.5*BrainRegion.Diagnosis.SEXFP.CONTROL.FEMALE
         -0.5*BrainRegion.Diagnosis.SEXFP.AD.MALE-0.5*BrainRegion.Diagnosis.SEXFP.CONTROL.FEMALE',
         '0.5*BrainRegion.Diagnosis.SEXFP.AD.FEMALE-0.5*BrainRegion.Diagnosis.SEXFP.CONTROL.FEMALE
         -0.5*BrainRegion.Diagnosis.SEXFP.AD.MALE+0.5*BrainRegion.Diagnosis.SEXFP.CONTROL.MALE',
         'BrainRegion.Diagnosis.SEXPHG.AD.MALE-BrainRegion.Diagnosis.SEXPHG.CONTROL.MALE',
         'BrainRegion.Diagnosis.SEXPHG.AD.FEMALE-BrainRegion.Diagnosis.SEXPHG.CONTROL.FEMALE',
         '0.5*BrainRegion.Diagnosis.SEXPHG.AD.MALE+0.5*BrainRegion.Diagnosis.SEXPHG.AD.FEMALE
         -0.5*BrainRegion.Diagnosis.SEXPHG.CONTROL.MALE-0.5*BrainRegion.Diagnosis.SEXPHG.CONTROL.FEMALE',
         '0.5*BrainRegion.Diagnosis.SEXPHG.AD.FEMALE+0.5*BrainRegion.Diagnosis.SEXPHG.CONTROL.FEMALE
         -0.5*BrainRegion.Diagnosis.SEXPHG.AD.MALE-0.5*BrainRegion.Diagnosis.SEXPHG.CONTROL.FEMALE',
         '0.5*BrainRegion.Diagnosis.SEXPHG.AD.FEMALE-0.5*BrainRegion.Diagnosis.SEXPHG.CONTROL.FEMALE
         -0.5*BrainRegion.Diagnosis.SEXPHG.AD.MALE+0.5*BrainRegion.Diagnosis.SEXPHG.CONTROL.MALE',
         'BrainRegion.Diagnosis.SEXSTG.AD.MALE-BrainRegion.Diagnosis.SEXSTG.CONTROL.MALE',
         'BrainRegion.Diagnosis.SEXSTG.AD.FEMALE-BrainRegion.Diagnosis.SEXSTG.CONTROL.FEMALE',
         '0.5*BrainRegion.Diagnosis.SEXSTG.AD.MALE+0.5*BrainRegion.Diagnosis.SEXSTG.AD.FEMALE
         -0.5*BrainRegion.Diagnosis.SEXSTG.CONTROL.MALE-0.5*BrainRegion.Diagnosis.SEXSTG.CONTROL.FEMALE',
         '0.5*BrainRegion.Diagnosis.SEXSTG.AD.FEMALE+0.5*BrainRegion.Diagnosis.SEXSTG.CONTROL.FEMALE
         -0.5*BrainRegion.Diagnosis.SEXSTG.AD.MALE-0.5*BrainRegion.Diagnosis.SEXSTG.CONTROL.FEMALE',
         '0.5*BrainRegion.Diagnosis.SEXSTG.AD.FEMALE-0.5*BrainRegion.Diagnosis.SEXSTG.CONTROL.FEMALE
         -0.5*BrainRegion.Diagnosis.SEXSTG.AD.MALE+0.5*BrainRegion.Diagnosis.SEXSTG.CONTROL.MALE')
contrast = makeContrasts(contrasts = cntr,
                         levels = colnames(FIT$coefficients))
colnames(contrast) = c('IFG.AD.MALE-IFG.CONTROL.MALE',
                       'IFG.AD.FEMALE-IFG.CONTROL.FEMALE',
                       'IFG.AD.ALL-IFG.CONTROL.ALL',
                       'IFG.ALL.FEMALE-IFG.ALL.MALE',
                       'IFG.ALL.ALL-IFG.ALL.ALL',
                       'FP.AD.MALE-FP.CONTROL.MALE',
                       'FP.AD.FEMALE-FP.CONTROL.FEMALE',
                       'FP.AD.ALL-FP.CONTROL.ALL',
                       'FP.ALL.FEMALE-FP.ALL.MALE',
                       'FP.ALL.ALL-FP.ALL.ALL',
                       'PHG.AD.MALE-PHG.CONTROL.MALE',
                       'PHG.AD.FEMALE-PHG.CONTROL.FEMALE',
                       'PHG.AD.ALL-PHG.CONTROL.ALL',
                       'PHG.ALL.FEMALE-PHG.ALL.MALE',
                       'PHG.ALL.ALL-PHG.ALL.ALL',
                       'STG.AD.MALE-STG.CONTROL.MALE',
                       'STG.AD.FEMALE-STG.CONTROL.FEMALE',
                       'STG.AD.ALL-STG.CONTROL.ALL',
                       'STG.ALL.FEMALE-STG.ALL.MALE',
                       'STG.ALL.ALL-STG.ALL.ALL')

FIT.CONTR = contrasts.fit(FIT, contrasts=contrast)
FIT.CONTR = eBayes(FIT.CONTR)

# Get differnetial expression
DE = lapply(1:dim(contrast)[2], function(i, FIT){
  topTable(FIT, coef=i, number = 50000, confint = T) %>%
    rownameToFirstColumn('Tx.ID')
}, FIT.CONTR)
names(DE) = colnames(contrast)

DE = DE %>% 
  rbindlist(idcol = 'Comparison') %>%
  dplyr::mutate(Comparison = gsub('BrainRegion.Diagnosis','',Comparison),
                Study = 'MSSM',
                Direction = logFC/abs(logFC),
                Direction = factor(Direction, c(-1,1), c('-1' = 'DOWN', '1' = 'UP')),
                Direction = as.character(Direction))
DE$Direction[DE$adj.P.Val > 0.05 | abs(DE$logFC) < log2(1.2)] = 'NONE'

tmp = DE %>%
  dplyr::select(Tx.ID, Comparison, Direction) %>%
  group_by(Comparison, Direction) %>%
  dplyr::summarise(FDR_0_05_FC_1.2 = length(unique(Tx.ID))) %>%
  spread(Direction, FDR_0_05_FC_1.2) 
kable(tmp)

all.diff.exp = c(all.diff.exp, list(Diagnosis.SEX = DE))
all.fit = c(all.fit, list(Diagnosis.SEX = FIT))
```

### Differential expression analysis (with BrainRegion.Diagnosis and AOD)
Differential expression is performed on the BrainRegion.Diagnosis x AOD variable by controlling for covariates identified above

Genes that are differentially expressed at an FDR <= 0.05 and folde change of 1.2 are
```{r diff.exp4, fig.height=15, fig.width=13}
# Get design matrix
DESIGN = getDesignMatrix(COVARIATES[, c(primaryVariable[2], setdiff(postAdjustCovars, 'AOD')), drop = F], Intercept = F)
ind = grep('Diagnosis', colnames(DESIGN$design))
DESIGN$design[,ind] = DESIGN$design[,ind] * COVARIATES[rownames(DESIGN$design),'AOD']
DESIGN$design = DESIGN$design[,linColumnFinder(DESIGN$design)$indepCols]
colnames(DESIGN$design)[ind] = gsub('BrainRegion.Diagnosis', '', paste0(colnames(DESIGN$design)[ind], '.AOD'))

# Estimate voom weights for dispersion control
VOOM.WEIGHTS = voom(NEW.COUNTS, design=DESIGN$design, plot=F, lib.size = LIB.SIZE * TMM.GENE_EXPRESSION)

# Calculate correlation values of random effects
correlation = parallelDuplicateCorrelation(VOOM.WEIGHTS, block = COVARIATES$individualIdentifier)
  
# Re-estimate voom weights
VOOM.WEIGHTS = voom(NEW.COUNTS,
                    design=DESIGN$design, plot=F,
                    block = COVARIATES$individualIdentifier, 
                    correlation = correlation$cor,
                    lib.size = LIB.SIZE * TMM.GENE_EXPRESSION)

# Fit linear model using new weights and new design
FIT = lmFit(VOOM.WEIGHTS$E,
            weights = VOOM.WEIGHTS$weights,
            design=DESIGN$design,
            block = COVARIATES$individualIdentifier, 
            correlation = correlation$cor)

# Fit contrast
cntr = c("FP.AD.AOD-FP.CONTROL.AOD",
         "0.5*FP.AD.AOD+0.5*FP.CONTROL.AOD",
         "IFG.AD.AOD-IFG.CONTROL.AOD",
         "0.5*IFG.AD.AOD+0.5*IFG.CONTROL.AOD",
         "PHG.AD.AOD-PHG.CONTROL.AOD",
         "0.5*PHG.AD.AOD+0.5*PHG.CONTROL.AOD",
         "STG.AD.AOD-STG.CONTROL.AOD",
         "0.5*STG.AD.AOD+0.5*STG.CONTROL.AOD")
contrast = makeContrasts(contrasts=cntr,
                         levels = colnames(FIT$coefficients))
colnames(contrast) = c("FP.AD.AOD-FP.CONTROL.AOD",
                       "FP.ALL.AOD",
                       "IFG.AD.AOD-IFG.CONTROL.AOD",
                       "IFG.ALL.AOD",
                       "PHG.AD.AOD-PHG.CONTROL.AOD",
                       "PHG.ALL.AOD",
                       "STG.AD.AOD-STG.CONTROL.AOD",
                       "STG.ALL.AOD")
FIT.CONTR = contrasts.fit(FIT, contrasts=contrast)
FIT.CONTR = eBayes(FIT.CONTR)

# Get differnetial expression
DE = lapply(1:dim(contrast)[2], function(i, FIT){
  topTable(FIT, coef=i, number = 50000, confint = T) %>%
    rownameToFirstColumn('Tx.ID')
}, FIT.CONTR)
names(DE) = colnames(contrast)

DE = DE %>% 
  rbindlist(idcol = 'Comparison') %>%
  dplyr::mutate(Comparison = gsub('BrainRegion.Diagnosis','',Comparison),
                Study = 'MSSM',
                Direction = logFC/abs(logFC),
                Direction = factor(Direction, c(-1,1), c('-1' = 'DOWN', '1' = 'UP')),
                Direction = as.character(Direction))
DE$Direction[DE$adj.P.Val > 0.05 | abs(DE$logFC) < log2(1.2)] = 'NONE'

tmp = DE %>%
  dplyr::select(Tx.ID, Comparison, Direction) %>%
  group_by(Comparison, Direction) %>%
  dplyr::summarise(FDR_0_05_FC_1.2 = length(unique(Tx.ID))) %>%
  spread(Direction, FDR_0_05_FC_1.2) 
kable(tmp)

all.diff.exp = c(all.diff.exp, list(Diagnosis.AOD = DE))
all.fit = c(all.fit, list(Diagnosis.AOD = FIT))
```

### Store files in synapse
```{r synapse.store, include=FALSE, eval=TRUE, cache=FALSE}
# Function to change entity ACL (also creates new acls if it doesn't exist)
synChangeEntityACL <- function(id, new.racl){
  tryCatch({ 
    # If old acl exist update
    old.acl = synGetEntityACL(id)
    old.acl@resourceAccess = new.racl
    synUpdateEntityACL(old.acl)
  }, error = function(e){ 
    # If not create a new acl
    new.acl = AccessControlList(id = id, resourceAccess = new.racl)
    synCreateEntityACL(new.acl)
  })
}

# Set annotations
all.annotations = list(
  dataType = 'mRNA',
  dataSubType = 'isoformExp',
  summaryLevel = 'transcript',
  assay	 = 'RNAseq',
  assaySubType = 'Reprocessed',

  tissueTypeAbrv	= 'FP, STG, PHG, IFG', 
  study = 'MSSMRNASeq', 
  center = 'MSBB',
  
  organism = 'HomoSapiens',
  consortium	= 'AMP-AD',
   
  normalizationStatus	= TRUE,
  modelSystem	= FALSE,
  
  normalizationType	= 'TMM'
)

# Create new resource acls
new.racl = ResourceAccess(principalId = '3319864', 
                          accessType = c('UPDATE', 'CHANGE_SETTINGS', 'DELETE', 'READ', 
                                         'DOWNLOAD', 'MODERATE', 'CREATE', 'CHANGE_PERMISSIONS')) %>%
  ResourceAccessList() %>%
  synapseClient::append(ResourceAccess(principalId = '274008', 
                                       accessType = c('UPDATE', 'CHANGE_SETTINGS', 'DELETE', 'READ', 
                                                      'DOWNLOAD', 'MODERATE', 'CREATE', 'CHANGE_PERMISSIONS'))) %>%
  synapseClient::append(ResourceAccess(principalId = '273995', 
                                       accessType = c('UPDATE', 'CHANGE_SETTINGS', 'DELETE', 'READ', 
                                                      'DOWNLOAD', 'MODERATE', 'CREATE', 'CHANGE_PERMISSIONS'))) %>%
  synapseClient::append(ResourceAccess(principalId = '3359054', 
                                       accessType = c('READ', 'DOWNLOAD')))

# Code
CODE <- Folder(name = "MSSM Reprocessed Isoform (Normalised)", parentId = parentId)
annotations(CODE) = all.annotations
CODE <- synStore(CODE)
synChangeEntityACL(CODE@properties$id, new.racl)

# Store covariates
COVARIATES = rownameToFirstColumn(COVARIATES, 'SampleID')
write.table(COVARIATES, file = 'MSSM_FP_STG_PHG_IFG_Covariates.tsv', sep = '\t', row.names=F, quote=F)
COV_OBJ = File('MSSM_FP_STG_PHG_IFG_Covariates.tsv', name = 'Covariates', parentId = CODE$properties$id)
annotations(COV_OBJ) = annotations(CODE)
annotations(COV_OBJ)$dataSubType = 'covariates'
COV_OBJ = synStore(COV_OBJ, used = ALL_USED_IDs, activityName = activityName, 
                      executed = thisFile, activityDescription = activityDescription)
synChangeEntityACL(COV_OBJ@properties$id, new.racl)

# Store filtered TPM
PROCESSED_COUNTS$filteredExprMatrix$counts %>%
  rownameToFirstColumn('Tx.ID') %>%
  write.table(file = 'MSSM_FP_STG_PHG_IFG_TPM.tsv', sep = '\t', row.names=F, quote=F)
COUNT_OBJ = File('MSSM_FP_STG_PHG_IFG_TPM.tsv', name = 'TPM (raw)', parentId = CODE$properties$id)
annotations(COUNT_OBJ) = annotations(CODE)
annotations(COUNT_OBJ)$dataSubType = 'filteredTPM'
COUNT_OBJ = synStore(COUNT_OBJ, activity = synGetActivity(COV_OBJ$properties$id))

# Store filtered TPM
NEW.COUNTS %>%
  rownameToFirstColumn('Tx.ID') %>%
  write.table(file = 'MSSM_FP_STG_PHG_IFG_eTPM.tsv', sep = '\t', row.names=F, quote=F)
ECOUNT_OBJ = File('MSSM_FP_STG_PHG_IFG_eTPM.tsv', name = 'TPM (estimated)', parentId = CODE$properties$id)
annotations(ECOUNT_OBJ) = annotations(CODE)
annotations(ECOUNT_OBJ)$dataSubType = 'estimatedTPM'
ECOUNT_OBJ = synStore(ECOUNT_OBJ, activity = synGetActivity(COV_OBJ$properties$id))

# Store logCPM
VOOM.GENE_EXPRESSION$E %>%
  rownameToFirstColumn('Tx.ID') %>%
  write.table(file = 'MSSM_FP_STG_PHG_IFG_logCPM.tsv', sep = '\t', row.names=F, quote=F)
LCOUNT_OBJ = File('MSSM_FP_STG_PHG_IFG_logCPM.tsv', name = 'Log TPM (filtered)', parentId = CODE$properties$id)
annotations(LCOUNT_OBJ) = annotations(CODE)
annotations(LCOUNT_OBJ)$dataSubType = 'filteredLCPM'
LCOUNT_OBJ = synStore(LCOUNT_OBJ, activity = synGetActivity(COV_OBJ$properties$id))

# Store design matrix
DM1$design %>%
  rownameToFirstColumn('SampleID') %>%
  write.table(file = 'MSSM_FP_STG_PHG_IFG_Design.tsv', sep = '\t', row.names=F, quote=F)
DM_OBJ = File('MSSM_FP_STG_PHG_IFG_Design.tsv', name = 'Design Matrix', parentId = CODE$properties$id)
annotations(DM_OBJ) = annotations(CODE)
annotations(DM_OBJ)$dataSubType = 'designMatrix'
DM_OBJ = synStore(DM_OBJ, activity = synGetActivity(COV_OBJ$properties$id))
synChangeEntityACL(DM_OBJ@properties$id, new.racl)

# Store differential expression results
rbindlist(all.diff.exp, use.names = T, fill = T, idcol = 'Model') %>%
  write.table(file = 'MSSM_FP_STG_PHG_IFG_DiffExpression.tsv', sep = '\t', row.names=F, quote=F)
DEXP_OBJ = File('MSSM_FP_STG_PHG_IFG_DiffExpression.tsv', name = 'Differential Expression Results (BrainRegion.Diagnosis)', 
                parentId = CODE$properties$id)
annotations(DEXP_OBJ) = annotations(CODE)
annotations(DEXP_OBJ)$dataSubType = 'diffExp'
DEXP_OBJ = synStore(DEXP_OBJ, activity = synGetActivity(COV_OBJ$properties$id))

# Store all differential expression models
save(all.fit, file = 'MSSM_FP_STG_PHG_IFG_Models.RData')
FIT_OBJ = File('MSSM_FP_STG_PHG_IFG_Models.RData', 
               name = 'All Limma Models',
               parentId = CODE$properties$id)
annotations(FIT_OBJ) = annotations(CODE)
annotations(FIT_OBJ)$dataSubType = 'modelFits'
FIT_OBJ = synStore(FIT_OBJ, activity = synGetActivity(COV_OBJ$properties$id))
synChangeEntityACL(FIT_OBJ@properties$id, new.racl)

# Delete folder acl
synDeleteEntityACL(CODE@properties$id)
```
|  *Results*                                  |  *SynapseID*                     |
|  -----------------------------------------  |   ---------                      |
|  Covariates                                 |  `r COV_OBJ$properties$id`       |
|  TPM (raw)                                  |  `r COUNT_OBJ$properties$id`     |
|  TPM (estimated)                            |  `r ECOUNT_OBJ$properties$id`    |
|  TPM (lcpm)                                 |  `r LCOUNT_OBJ$properties$id`    |
|  Design Matrix                              |  `r DM_OBJ$properties$id`        |
|  Differential Expression                    |  `r DEXP_OBJ$properties$id`      |